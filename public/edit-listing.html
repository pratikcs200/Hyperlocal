<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Listing - Hyperlocal Marketplace</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">üè™ Local Marketplace</a>
                <nav>
                    <ul class="nav-links">
                        <li><a href="/">Home</a></li>
                        <li><a href="/create-listing.html">Sell Item</a></li>
                        <li><a href="/cart.html">Cart</a></li>
                        <li><a href="/orders.html">My Orders</a></li>
                        <li><a href="/seller-orders.html">Seller Dashboard</a></li>
                        <li><a href="/chat.html">Messages</a></li>
                    </ul>
                </nav>
                <div class="user-info">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="form-container" style="max-width: 600px;">
                <h2 class="text-center mb-3">Edit Listing</h2>
                
                <div id="loadingMessage" class="text-center">
                    <div class="spinner"></div>
                    <p>Loading listing details...</p>
                </div>
                
                <form id="editListingForm" style="display: none;">
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description *</label>
                        <textarea id="description" class="form-control" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="price">Price (‚Çπ) *</label>
                        <input type="number" id="price" class="form-control" min="0" step="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" class="form-control" required>
                            <option value="">Select Category</option>
                            <option value="electronics">Electronics</option>
                            <option value="furniture">Furniture</option>
                            <option value="clothing">Clothing</option>
                            <option value="books">Books</option>
                            <option value="sports">Sports</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" class="form-control" required>
                            <option value="active">Active</option>
                            <option value="sold">Sold</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Current Images</label>
                        <div id="currentImages" class="mb-2">
                            <!-- Current images will be displayed here -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="newImages">Add New Images (Max 5 total)</label>
                        <input type="file" id="newImages" class="form-control" multiple accept="image/*">
                        <small>Supported formats: JPG, PNG, GIF, WebP (Max 5MB each)</small>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary" id="updateBtn">Update Listing</button>
                        <a href="#" id="cancelBtn" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="/js/auth.js"></script>
    <script>
        // Check authentication
        if (!Auth.isAuthenticated()) {
            window.location.href = '/login.html';
        }

        let currentListing = null;
        let listingId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            listingId = urlParams.get('id');
            
            if (!listingId) {
                showAlert('Listing ID not provided', 'error');
                window.location.href = '/';
                return;
            }
            
            await loadListingForEdit();
            
            document.getElementById('editListingForm').addEventListener('submit', handleUpdate);
            document.getElementById('cancelBtn').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = `/listing.html?id=${listingId}`;
            });
        });

        async function loadListingForEdit() {
            try {
                const response = await Auth.apiRequest(`/api/listings/${listingId}`);
                
                if (!response.ok) {
                    throw new Error('Listing not found');
                }
                
                currentListing = await response.json();
                
                // Check if current user is the owner
                const currentUser = Auth.getUser();
                if (currentListing.userId._id !== currentUser.id) {
                    showAlert('You can only edit your own listings', 'error');
                    window.location.href = `/listing.html?id=${listingId}`;
                    return;
                }
                
                // Populate form fields
                document.getElementById('title').value = currentListing.title;
                document.getElementById('description').value = currentListing.description;
                document.getElementById('price').value = currentListing.price;
                document.getElementById('category').value = currentListing.category;
                document.getElementById('status').value = currentListing.status;
                
                // Display current images
                displayCurrentImages();
                
                // Show form and hide loading
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('editListingForm').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading listing:', error);
                showAlert('Error loading listing for edit', 'error');
                window.location.href = '/';
            }
        }

        function displayCurrentImages() {
            const currentImagesDiv = document.getElementById('currentImages');
            
            if (currentListing.images && currentListing.images.length > 0) {
                currentImagesDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem;">
                        ${currentListing.images.map((image, index) => `
                            <div style="position: relative;">
                                <img src="/uploads/${image}" alt="Current image" 
                                     style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                <button type="button" onclick="removeImage(${index})" 
                                        style="position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                currentImagesDiv.innerHTML = '<p style="color: #666;">No images currently uploaded</p>';
            }
        }

        function removeImage(index) {
            if (confirm('Remove this image?')) {
                currentListing.images.splice(index, 1);
                displayCurrentImages();
            }
        }

        // Validate file selection
        document.getElementById('newImages').addEventListener('change', (e) => {
            const files = e.target.files;
            const currentImageCount = currentListing.images ? currentListing.images.length : 0;
            
            if (currentImageCount + files.length > 5) {
                showAlert('Maximum 5 images allowed in total', 'error');
                e.target.value = '';
                return;
            }
            
            for (let file of files) {
                if (file.size > 5 * 1024 * 1024) { // 5MB
                    showAlert('Each image must be less than 5MB', 'error');
                    e.target.value = '';
                    return;
                }
            }
        });

        async function handleUpdate(e) {
            e.preventDefault();
            
            const updateBtn = document.getElementById('updateBtn');
            const originalText = updateBtn.textContent;
            updateBtn.textContent = 'Updating...';
            updateBtn.disabled = true;
            
            try {
                // First, update the basic listing details
                const updateData = {
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    price: parseFloat(document.getElementById('price').value),
                    category: document.getElementById('category').value,
                    status: document.getElementById('status').value,
                    images: currentListing.images // Keep existing images
                };
                
                const response = await Auth.apiRequest(`/api/listings/${listingId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update listing');
                }
                
                // If there are new images, upload them separately
                const newImages = document.getElementById('newImages').files;
                if (newImages.length > 0) {
                    await uploadNewImages(newImages);
                }
                
                showAlert('Listing updated successfully!', 'success');
                
                setTimeout(() => {
                    window.location.href = `/listing.html?id=${listingId}`;
                }, 1000);
                
            } catch (error) {
                console.error('Error updating listing:', error);
                showAlert(error.message || 'Failed to update listing', 'error');
            } finally {
                updateBtn.textContent = originalText;
                updateBtn.disabled = false;
            }
        }

        async function uploadNewImages(files) {
            const formData = new FormData();
            formData.append('title', document.getElementById('title').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('price', document.getElementById('price').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('status', document.getElementById('status').value);
            
            // Add existing images
            currentListing.images.forEach(image => {
                formData.append('existingImages', image);
            });
            
            // Add new images
            for (let i = 0; i < files.length; i++) {
                formData.append('images', files[i]);
            }
            
            const response = await Auth.apiRequest(`/api/listings/${listingId}/images`, {
                method: 'PUT',
                body: formData,
                headers: {} // Remove Content-Type to let browser set it for FormData
            });
            
            if (!response.ok) {
                throw new Error('Failed to upload new images');
            }
        }
    </script>
</body>
</html>