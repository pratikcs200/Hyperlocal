<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Hyperlocal Marketplace</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">üè™ Local Marketplace</a>
                <button class="nav-toggle" onclick="toggleNavigation()" aria-label="Toggle navigation">
                    ‚ò∞
                </button>
                <nav>
                    <ul class="nav-links" id="navLinks">
                        <li><a href="/">Home</a></li>
                        <li><a href="/orders.html">My Orders</a></li>
                        <li><a href="/admin.html">Admin</a></li>
                    </ul>
                </nav>
                <div class="user-info">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="admin-panel">
                <div class="admin-header">
                    <h2>Admin Dashboard</h2>
                </div>
                
                <div class="admin-content">
                    <!-- Stats Section -->
                    <div id="statsSection">
                        <h3>Platform Statistics</h3>
                        <div class="stats-grid" id="statsGrid">
                            <!-- Stats will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Listings Management -->
                    <div style="margin-top: 3rem;">
                        <h3>Listings Management</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label for="statusFilter">Filter by Status:</label>
                            <select id="statusFilter" class="form-control" style="width: 200px; display: inline-block; margin-left: 1rem;">
                                <option value="">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="sold">Sold</option>
                            </select>
                            <button onclick="loadListings()" class="btn btn-primary" style="margin-left: 1rem;">Filter</button>
                        </div>
                        
                        <div class="table-container">
                            <table class="table" id="listingsTable">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Seller</th>
                                        <th>Price</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="listingsTableBody">
                                    <!-- Listings will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="pagination" class="text-center" style="margin-top: 2rem;">
                            <!-- Pagination will be added here -->
                        </div>
                    </div>
                    
                    <!-- Users Management -->
                    <div style="margin-top: 3rem;">
                        <h3>Users Management</h3>
                        
                        <div class="table-container">
                            <table class="table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Rating</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/auth.js"></script>
    <script>
        // Toggle mobile navigation
        function toggleNavigation() {
            const navLinks = document.getElementById('navLinks');
            navLinks.classList.toggle('show');
        }

        // Close mobile nav when clicking on links
        document.addEventListener('click', (e) => {
            const navLinks = document.getElementById('navLinks');
            
            if (e.target.closest('.nav-links a') || (!e.target.closest('.nav-toggle') && !e.target.closest('.nav-links'))) {
                navLinks.classList.remove('show');
            }
        });

        // Check if user is admin
        if (!Auth.isAuthenticated() || !Auth.isAdmin()) {
            showAlert('Admin access required', 'error');
            window.location.href = '/';
        }

        let currentPage = 1;
        const itemsPerPage = 10;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadStats();
            await loadListings();
            await loadUsers();
        });

        async function loadStats() {
            try {
                const response = await Auth.apiRequest('/api/admin/stats');
                const stats = await response.json();
                
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalUsers}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalListings}</div>
                        <div class="stat-label">Total Listings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.activeListings}</div>
                        <div class="stat-label">Active Listings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalServices}</div>
                        <div class="stat-label">Total Services</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadListings(page = 1) {
            try {
                const status = document.getElementById('statusFilter').value;
                const params = new URLSearchParams({
                    page: page,
                    limit: itemsPerPage
                });
                
                if (status) {
                    params.append('status', status);
                }
                
                const response = await Auth.apiRequest(`/api/admin/listings?${params}`);
                const data = await response.json();
                
                const tbody = document.getElementById('listingsTableBody');
                tbody.innerHTML = data.listings.map(listing => `
                    <tr>
                        <td><a href="/listing.html?id=${listing._id}" target="_blank">${listing.title}</a></td>
                        <td>${listing.userId.name}<br><small>${listing.userId.email}</small></td>
                        <td>${formatPrice(listing.price)}</td>
                        <td>${listing.category}</td>
                        <td>
                            <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; 
                                         background: ${getStatusColor(listing.status)}; color: white;">
                                ${listing.status.toUpperCase()}
                            </span>
                        </td>
                        <td>${formatDate(listing.createdAt)}</td>
                        <td>
                            <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                ${listing.status === 'pending' ? `
                                    <button onclick="approveListing('${listing._id}')" class="btn btn-success btn-sm">Approve</button>
                                    <button onclick="rejectListing('${listing._id}')" class="btn btn-danger btn-sm">Reject</button>
                                ` : ''}
                                <button onclick="deleteListing('${listing._id}')" class="btn btn-danger btn-sm">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                // Update pagination
                updatePagination(data.currentPage, data.totalPages, 'loadListings');
                
            } catch (error) {
                console.error('Error loading listings:', error);
            }
        }

        async function loadUsers(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: itemsPerPage
                });
                
                const response = await Auth.apiRequest(`/api/admin/users?${params}`);
                const data = await response.json();
                
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = data.users.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>
                            <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; 
                                         background: ${user.role === 'admin' ? '#e74c3c' : '#3498db'}; color: white;">
                                ${user.role.toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <div class="rating">
                                <span class="stars">${generateStars(user.rating)}</span>
                                <span>(${user.rating.toFixed(1)})</span>
                            </div>
                        </td>
                        <td>${formatDate(user.createdAt)}</td>
                        <td>
                            <button onclick="viewUserDetails('${user._id}')" class="btn btn-secondary btn-sm">View</button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'active': return '#27ae60';
                case 'pending': return '#f39c12';
                case 'sold': return '#95a5a6';
                case 'rejected': return '#e74c3c';
                default: return '#95a5a6';
            }
        }

        function updatePagination(currentPage, totalPages, loadFunction) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHtml = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHtml += `<button onclick="${loadFunction}(${currentPage - 1})" class="btn btn-secondary">Previous</button> `;
            }
            
            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                if (i === currentPage) {
                    paginationHtml += `<button class="btn btn-primary">${i}</button> `;
                } else {
                    paginationHtml += `<button onclick="${loadFunction}(${i})" class="btn btn-secondary">${i}</button> `;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHtml += `<button onclick="${loadFunction}(${currentPage + 1})" class="btn btn-secondary">Next</button>`;
            }
            
            pagination.innerHTML = paginationHtml;
        }

        async function approveListing(listingId) {
            try {
                const response = await Auth.apiRequest(`/api/admin/listings/${listingId}/approve`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    showAlert('Listing approved successfully', 'success');
                    await loadListings(currentPage);
                    await loadStats();
                } else {
                    const data = await response.json();
                    showAlert(data.message || 'Failed to approve listing', 'error');
                }
            } catch (error) {
                console.error('Error approving listing:', error);
                showAlert('Network error. Please try again.', 'error');
            }
        }

        async function rejectListing(listingId) {
            if (!confirm('Are you sure you want to reject this listing?')) {
                return;
            }
            
            try {
                const response = await Auth.apiRequest(`/api/admin/listings/${listingId}/reject`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    showAlert('Listing rejected successfully', 'success');
                    await loadListings(currentPage);
                } else {
                    const data = await response.json();
                    showAlert(data.message || 'Failed to reject listing', 'error');
                }
            } catch (error) {
                console.error('Error rejecting listing:', error);
                showAlert('Network error. Please try again.', 'error');
            }
        }

        async function deleteListing(listingId) {
            if (!confirm('Are you sure you want to delete this listing? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await Auth.apiRequest(`/api/admin/listings/${listingId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('Listing deleted successfully', 'success');
                    await loadListings(currentPage);
                    await loadStats();
                } else {
                    const data = await response.json();
                    showAlert(data.message || 'Failed to delete listing', 'error');
                }
            } catch (error) {
                console.error('Error deleting listing:', error);
                showAlert('Network error. Please try again.', 'error');
            }
        }

        function viewUserDetails(userId) {
            // In a real app, this would open a detailed user view
            showAlert('User details view would be implemented here', 'info');
        }
    </script>
</body>
</html>