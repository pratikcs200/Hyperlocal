<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Hyperlocal Marketplace</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">üè™ Local Marketplace</a>
                <nav>
                    <ul class="nav-links">
                        <li><a href="/">Home</a></li>
                        <li><a href="/create-listing.html">Sell Item</a></li>
                        <li><a href="/cart.html">Cart (<span id="cartCount">0</span>)</a></li>
                        <li><a href="/chat.html">Messages</a></li>
                    </ul>
                </nav>
                <div class="user-info">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <h2>Shopping Cart</h2>
            
            <div id="cartContent">
                <!-- Cart content will be loaded here -->
            </div>
        </div>
    </main>

    <script src="/js/auth.js"></script>
    <script>
        // Check authentication
        if (!Auth.isAuthenticated()) {
            window.location.href = '/login.html';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCart();
        });

        async function loadCart() {
            const cartContent = document.getElementById('cartContent');
            
            try {
                const response = await Auth.apiRequest('/api/cart');
                const cartData = await response.json();
                
                if (cartData.items.length === 0) {
                    cartContent.innerHTML = `
                        <div class="text-center" style="padding: 3rem;">
                            <h3>Your cart is empty</h3>
                            <p>Start shopping to add items to your cart!</p>
                            <a href="/" class="btn btn-primary">Continue Shopping</a>
                        </div>
                    `;
                    document.getElementById('cartCount').textContent = '0';
                    return;
                }
                
                document.getElementById('cartCount').textContent = cartData.items.length;
                
                cartContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                        <!-- Cart Items -->
                        <div>
                            <div class="cart-items">
                                ${cartData.items.map(item => `
                                    <div class="cart-item" style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1rem;">
                                        <div style="display: grid; grid-template-columns: 100px 1fr auto; gap: 1rem; align-items: center;">
                                            <div>
                                                ${item.listingId.images && item.listingId.images.length > 0 
                                                    ? `<img src="/uploads/${item.listingId.images[0]}" alt="${item.listingId.title}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">`
                                                    : '<div style="width: 100px; height: 100px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666;">No Image</div>'
                                                }
                                            </div>
                                            <div>
                                                <h4>${item.listingId.title}</h4>
                                                <p style="color: #666; margin: 0.5rem 0;">By ${item.listingId.userId.name}</p>
                                                <div style="font-size: 1.2rem; font-weight: bold; color: #27ae60;">
                                                    ${formatPrice(item.listingId.price)}
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                                    <button onclick="updateQuantity('${item.listingId._id}', ${item.quantity - 1})" class="btn btn-secondary" style="padding: 0.25rem 0.5rem;">-</button>
                                                    <span style="padding: 0.5rem; min-width: 40px; text-align: center;">${item.quantity}</span>
                                                    <button onclick="updateQuantity('${item.listingId._id}', ${item.quantity + 1})" class="btn btn-secondary" style="padding: 0.25rem 0.5rem;">+</button>
                                                </div>
                                                <button onclick="removeFromCart('${item.listingId._id}')" class="btn btn-danger" style="padding: 0.5rem;">Remove</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Order Summary -->
                        <div>
                            <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 2rem;">
                                <h3>Order Summary</h3>
                                <div style="border-bottom: 1px solid #eee; padding-bottom: 1rem; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Items (${cartData.items.length})</span>
                                        <span>${formatPrice(cartData.totalAmount)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Shipping</span>
                                        <span>Free</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; margin-bottom: 2rem;">
                                    <span>Total</span>
                                    <span>${formatPrice(cartData.totalAmount)}</span>
                                </div>
                                <button onclick="proceedToCheckout()" class="btn btn-primary btn-block">Proceed to Checkout</button>
                                <button onclick="clearCart()" class="btn btn-secondary btn-block" style="margin-top: 1rem;">Clear Cart</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading cart:', error);
                showAlert('Error loading cart', 'error');
            }
        }

        async function updateQuantity(listingId, newQuantity) {
            if (newQuantity < 1) return;
            
            try {
                const response = await Auth.apiRequest('/api/cart/update', {
                    method: 'PUT',
                    body: JSON.stringify({
                        listingId,
                        quantity: newQuantity
                    })
                });
                
                if (response.ok) {
                    await loadCart();
                } else {
                    const data = await response.json();
                    showAlert(data.message || 'Failed to update quantity', 'error');
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
                showAlert('Network error. Please try again.', 'error');
            }
        }

        async function removeFromCart(listingId) {
            if (!confirm('Remove this item from cart?')) return;
            
            try {
                const response = await Auth.apiRequest(`/api/cart/remove/${listingId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('Item removed from cart', 'success');
                    await loadCart();
                } else {
                    const data = await response.json();
                    showAlert(data.message || 'Failed to remove item', 'error');
                }
            } catch (error) {
                console.error('Error removing item:', error);
                showAlert('Network error. Please try again.', 'error');
            }
        }

        async function clearCart() {
            if (!confirm('Clear entire cart?')) return;
            
            try {
                const response = await Auth.apiRequest('/api/cart/clear', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('Cart cleared', 'success');
                    await loadCart();
                } else {
                    const data = await response.json();
                    showAlert(data.message || 'Failed to clear cart', 'error');
                }
            } catch (error) {
                console.error('Error clearing cart:', error);
                showAlert('Network error. Please try again.', 'error');
            }
        }

        function proceedToCheckout() {
            window.location.href = '/checkout.html';
        }
    </script>
</body>
</html>